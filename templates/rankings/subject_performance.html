{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-6">Subject Performance Analysis</h1>
    
    <!-- Filter Form -->
    <form method="get" class="mb-8 p-4 bg-gray-100 rounded">
        <div class="flex gap-4">
            <div>
                <label for="year" class="block text-sm font-medium text-gray-700">Year:</label>
                <select name="year" id="year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    {% for year in available_years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                            {{ year }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="term" class="block text-sm font-medium text-gray-700">Term:</label>
                <select name="term" id="term" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option value="">All Terms</option>
                    {% for term in available_terms %}
                        <option value="{{ term }}" {% if term == selected_term %}selected{% endif %}>
                            {{ term }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="self-end">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Filter
                </button>
            </div>
        </div>
    </form>
    
    <!-- Performance Display -->
    {% for term_data in analytics %}
    <div class="mb-12">
        <h2 class="text-xl font-semibold mb-4">{{ term_data.term }}</h2>
        
        <div class="overflow-x-auto shadow">
            <table class="min-w-full bg-white border border-gray-300 table-fixed">
                <thead>
                    <tr class="bg-gray-100">
                        <!-- Fixed columns -->
                        <th class="sticky left-0 z-10 bg-gray-100 px-4 py-2 border">Rank</th>
                        <th class="sticky left-[60px] z-10 bg-gray-100 px-4 py-2 border">Subject</th>
                        <th class="sticky left-[260px] z-10 bg-gray-100 px-4 py-2 border">Students</th>
                        <th class="sticky left-[360px] z-10 bg-gray-100 px-4 py-2 border">Mean Score</th>
                        <th class="sticky left-[460px] z-10 bg-gray-100 px-4 py-2 border">Points</th>
                        <th class="sticky left-[560px] z-10 bg-gray-100 px-4 py-2 border">Grade</th>
                        <th class="px-4 py-2 border">Quality %</th>
                        <th class="px-4 py-2 border">Pass Rate</th>
                        <th class="px-4 py-2 border">Grade Distribution</th>
                        
                        <!-- Stream columns -->
                        {% for stream in streams %}
                            <th class="px-4 py-2 border min-w-[150px] whitespace-nowrap">
                                {{ stream.name }} {{ stream.stream }}
                                <div class="text-xs font-normal">Score (Grade)</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for subject_data in term_data.subjects %}
                    <tr class="{% cycle 'bg-white' 'bg-gray-50' %}">
                        <!-- Fixed columns -->
                        <td class="sticky left-0 z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border text-center">
                            {{ subject_data.rank }}
                        </td>
                        <td class="sticky left-[60px] z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border font-medium">
                            {{ subject_data.subject.name }}
                        </td>
                        <td class="sticky left-[260px] z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border text-center">
                            {{ subject_data.total_students }}
                        </td>
                        <td class="sticky left-[360px] z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border text-center">
                            {{ subject_data.average_score }}%
                        </td>
                        <td class="sticky left-[460px] z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border text-center">
                            {{ subject_data.grade_points }}
                        </td>
                        <td class="sticky left-[560px] z-10 {% cycle 'bg-white' 'bg-gray-50' %} px-4 py-2 border text-center">
                            {{ subject_data.letter_grade }}
                        </td>
                        <td class="px-4 py-2 border text-center">
                            {{ subject_data.quality_percentage }}%
                        </td>
                        <td class="px-4 py-2 border text-center">
                            {{ subject_data.pass_rate }}%
                        </td>
                        <td class="px-4 py-2 border text-sm">
                            <div class="flex flex-wrap gap-2">
                                {% for grade, count in subject_data.grade_distribution.items %}
                                    <span class="px-2 py-1 rounded bg-gray-100">
                                        {{ grade }}: {{ count }}
                                    </span>
                                {% endfor %}
                            </div>
                        </td>
                        
                        <!-- Stream performance -->
                        {% for stream in streams %}
                            <td class="px-4 py-2 border text-center">
                                {% for stream_data in subject_data.streams %}
                                    {% if stream_data.stream.id == stream.id %}
                                        {{ stream_data.average_score }}% ({{ stream_data.letter_grade }})
                                        <div class="text-xs text-gray-500">{{ stream_data.students }} students</div>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-8">
        <p class="text-gray-500">No performance data available for the selected filters.</p>
    </div>
    {% endfor %}
</div>

<style>
    .table-fixed {
        table-layout: fixed;
    }
    
    .overflow-x-auto {
        scrollbar-width: thin;
        scrollbar-color: #CBD5E0 #EDF2F7;
    }
    
    .overflow-x-auto::-webkit-scrollbar {
        height: 8px;
    }
    
    .overflow-x-auto::-webkit-scrollbar-track {
        background: #EDF2F7;
    }
    
    .overflow-x-auto::-webkit-scrollbar-thumb {
        background-color: #CBD5E0;
        border-radius: 4px;
    }
</style>
{% endblock %}